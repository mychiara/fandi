<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Ukom Soal Review</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Internal CSS -->
    <style>
      :root {
        --primary-blue: #0d6efd;
        --primary-blue-hover: #0b5ed7;
        --secondary-blue: #e7f1ff;
        --light-bg: #f7f9fc;
        --dark-text: #212529;
        --gray-text: #6c757d;
        --border-color: #dee2e6;
        --success-color: #198754;
        --danger-color: #dc3545;
        --warning-color: #ffc107;
        --white-color: #fff;
        --shadow: 0 10px 30px rgba(0, 0, 0, 0.07);
        --shadow-sm: 0 4px 15px rgba(0, 0, 0, 0.05);
      }

      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(15px); }
        to { opacity: 1; transform: translateY(0); }
      }

      body { 
        background-color: var(--light-bg); 
        font-family: 'Inter', sans-serif;
        color: var(--dark-text);
        display: flex;
        flex-direction: column; /* <-- TAMBAHKAN INI */
        min-height: 100vh;
        /* HAPUS: align-items: center; */
        /* HAPUS: justify-content: center; */
      }

      #mainContainer {
        width: 100%;
        transition: max-width 0.3s ease-in-out;
        flex-grow: 1; /* <-- TAMBAHKAN INI */
        display: flex; /* <-- TAMBAHKAN INI */
        align-items: center; /* <-- TAMBAHKAN INI */
        justify-content: center; /* <-- TAMBAHKAN INI */
      }

      .container-login { max-width: 480px; }

      .content-card {
        display: none; 
        padding: 2.5rem; 
        background-color: var(--white-color); 
        border-radius: 1rem; 
        border: 1px solid var(--border-color);
        box-shadow: var(--shadow);
        animation: fadeIn 0.5s ease-out forwards;
      }

      /* User Info & Role Badge in Dashboard Header */
      #userInfoDosen, #userInfoReviewer, #userInfoAdmin, .role-badge {
        font-weight: 500;
      }
      .role-badge {
        font-size: 0.75rem;
        padding: 0.3em 0.6em;
        vertical-align: middle;
        margin-left: 8px;
        background-color: var(--secondary-blue);
        color: var(--primary-blue);
        border: 1px solid var(--primary-blue);
      }
      
      /* FORM ELEMENTS STYLING */
      .form-label { font-weight: 500; color: var(--gray-text); }
      .form-control, .form-select {
        border-radius: 0.5rem; padding: 0.75rem 1rem;
        border: 1px solid var(--border-color);
        transition: border-color .2s ease-in-out, box-shadow .2s ease-in-out;
      }
      .form-control:focus, .form-select:focus {
        border-color: var(--primary-blue);
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.15);
      }

      h2, h3 { color: var(--dark-text); font-weight: 600; display: flex; align-items: center; gap: 0.75rem;}
      h2 .bi, h3 .bi { font-size: 1.1em; color: var(--primary-blue);}

      /* BUTTONS */
      .btn { border-radius: 0.5rem; padding: 0.6rem 1.25rem; font-weight: 600; transition: all 0.2s ease; }
      .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.08); }
      .btn-primary { background-color: var(--primary-blue); border-color: var(--primary-blue); }
      .btn-primary:hover { background-color: var(--primary-blue-hover); border-color: var(--primary-blue-hover); }
      .btn .bi { margin-right: 0.5rem; vertical-align: -2px;}

      /* TABLES */
      .table { vertical-align: middle; }
      .table > :not(caption) > * > * { padding: 1rem; }
      .table thead th { 
        background-color: var(--light-bg); color: var(--dark-text); 
        font-weight: 600; border-bottom: 2px solid var(--primary-blue);
      }
      .table-hover > tbody > tr:hover > * {
        background-color: var(--secondary-blue);
      }
      
      /* REVIEWER CARD */
      .reviewer-card {
        border: 1px solid var(--border-color); border-radius: 0.75rem; box-shadow: var(--shadow-sm);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        border-left: 4px solid var(--primary-blue);
      }
      .reviewer-card:hover { transform: translateY(-4px); box-shadow: var(--shadow); }
      .reviewer-card .card-header {
        background-color: var(--secondary-blue); border-bottom: 1px solid var(--border-color);
        font-weight: 600; color: var(--primary-blue);
        border-radius: 0.75rem 0.75rem 0 0;
      }
      .reviewer-card .list-group-item.correct-answer {
        background-color: #d1e7dd; color: #0f5132;
        font-weight: 600; border-color: rgba(0,0,0,0.05);
      }

      /* STAT CARDS */
      .stat-card {
        background-color: var(--white-color); border-radius: 0.75rem;
        padding: 1.5rem; border: 1px solid var(--border-color);
        box-shadow: var(--shadow-sm); text-align: center;
        transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
      }
      .stat-card .stat-icon {
        font-size: 2.2rem; margin-bottom: 0.75rem; color: var(--primary-blue); display: block;
      }
      .stat-card .stat-value { font-size: 2rem; font-weight: 700; color: var(--dark-text); }
      .stat-card .stat-label { font-size: 0.9rem; color: var(--gray-text); font-weight: 500; }
      .stat-card.clickable { cursor: pointer; }
      .stat-card.clickable:hover {
        transform: translateY(-5px); box-shadow: var(--shadow); border-color: var(--primary-blue);
      }

      /* ADMIN DASHBOARD CARDS */
      .admin-sub-card {
        border: 1px solid var(--border-color);
        border-radius: 0.75rem;
        box-shadow: var(--shadow-sm);
      }

      /* LOGIN LOGO */
      .login-logo {
        max-width: 320px;
        margin-bottom: 1rem;
      }
            .app-footer {
        width: 100%;
        padding: 1.5rem 0;
        background-color: var(--white-color);
        border-top: 1px solid var(--border-color);
        color: var(--gray-text);
        font-size: 0.9rem;
        flex-shrink: 0; /* Mencegah footer menyusut */
      }
    </style>
  </head>
  <body>

    <main id="mainContainer" class="container-login">
      <!-- HALAMAN LOGIN (MODIFIED for EMAIL & LOGO) -->
      <div id="loginView" class="content-card text-center">
        <img src="https://osce.masandigital.com/LOGO%20POLTEKKES%20KEMENKES%20KUPANG.png" alt="Logo Poltekkes Kupang" class="login-logo">
        <h2 class="mt-2 justify-content-center">Selamat Datang di SiMiVig</h2>
        <h3 class="mt-2 justify-content-center">Review Soal Vignette Kebidanan</h3>
        <p class="text-muted mb-4">Silakan masuk untuk melanjutkan ke dashboard.</p>
        <div class="mb-3 text-start">
          <label for="emailInput" class="form-label">Email</label>
          <input type="email" id="emailInput" class="form-control" placeholder="Masukkan email Anda" autocomplete="email">
        </div>
        <div class="mb-3 text-start">
          <label for="passwordInput" class="form-label">Password</label>
          <input type="password" id="passwordInput" class="form-control" placeholder="Masukkan password Anda" autocomplete="current-password">
        </div>
        <button id="btnMasuk" class="btn btn-primary w-100 mt-3" disabled><i class="bi bi-box-arrow-in-right"></i> Masuk</button>
        <div id="loginSpinner" class="text-center mt-3" style="display:none;">
          <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>
        </div>
      </div>

      <!-- DASHBOARD DOSEN -->
      <div id="dosenView" class="content-card">
        <div class="d-flex justify-content-between align-items-center">
            <h2><i class="bi bi-person-workspace"></i> Dashboard Dosen</h2>
            <div class="d-flex align-items-center">
                <span id="userInfoDosen"></span>
                <button class="btn btn-outline-danger btn-sm ms-3 logout-button"><i class="bi bi-box-arrow-right m-0"></i></button>
            </div>
        </div>
        <hr>
        <div class="row g-5">
            <div class="col-lg-6">
                <h3 class="mt-4"><i class="bi bi-file-earmark-arrow-up-fill"></i> Upload Soal via Template</h3>
                <p class="text-muted">Untuk input banyak soal sekaligus, unduh template, isi, lalu unggah kembali.</p>
                <div class="card p-3 bg-light border">
                    <div class="row align-items-center g-2">
                        <div class="col-md-5"><button id="btnDownloadTemplateDosen" class="btn btn-success w-100"><i class="bi bi-download"></i> Download</button></div>
                        <div class="col-md-7">
                            <form id="formUploadSoal">
                                <div class="input-group"><input type="file" class="form-control" id="soalFileUpload" accept=".csv" required><button class="btn btn-primary" type="submit" title="Upload File"><i class="bi bi-upload m-0"></i></button></div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <h3 class="mt-4"><i class="bi bi-pencil-square"></i> Input Soal Manual</h3>
                 <form id="formSoal">
                    <div class="row g-3">
                        <div class="col-12"><input type="text" id="namaDosen" class="form-control" readonly></div>
                        <div class="col-12"><select id="peminatanDosen" class="form-select" required></select></div>
                        <div class="col-12"><textarea id="soalText" class="form-control" rows="3" placeholder="Tulis soal di sini..." required></textarea></div>
                        <div class="col-md-6"><input type="text" id="opsiA" class="form-control" placeholder="Opsi A" required></div>
                        <div class="col-md-6"><input type="text" id="opsiB" class="form-control" placeholder="Opsi B" required></div>
                        <div class="col-md-6"><input type="text" id="opsiC" class="form-control" placeholder="Opsi C" required></div>
                        <div class="col-md-6"><input type="text" id="opsiD" class="form-control" placeholder="Opsi D" required></div>
                        <div class="col-md-6"><input type="text" id="opsiE" class="form-control" placeholder="Opsi E" required></div>
                        <div class="col-md-6"><select id="kunciJawaban" class="form-select" required><option value="" disabled selected>Kunci Jawaban...</option><option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option><option value="E">E</option></select></div>
                        <div class="col-12"><button type="submit" class="btn btn-primary w-100"><i class="bi bi-send-check"></i> Kirim Soal</button></div>
                    </div>
                 </form>
            </div>
        </div>
        <hr class="my-5">
        <h3><i class="bi bi-clock-history"></i> Riwayat & Statistik Soal Anda</h3>
        <p class="text-muted">Ringkasan soal yang pernah Anda ajukan.</p>
        <div id="dosenStatSection" style="display:none;">
            <div class="row g-4 mb-4">
                <div class="col-md-4 col-sm-12"><div class="stat-card"><i class="bi bi-journal-arrow-up stat-icon"></i><div id="dosenTotalCount" class="stat-value">0</div><div class="stat-label">Total Diajukan</div></div></div>
                <div class="col-md-4 col-6"><div class="stat-card"><i class="bi bi-check-circle-fill stat-icon" style="color: var(--success-color);"></i><div id="dosenDiterimaCount" class="stat-value">0</div><div class="stat-label">Diterima</div></div></div>
                <div class="col-md-4 col-6"><div class="stat-card"><i class="bi bi-x-circle-fill stat-icon" style="color: var(--danger-color);"></i><div id="dosenDitolakCount" class="stat-value">0</div><div class="stat-label">Ditolak</div></div></div>
            </div>
        </div>
        <div id="riwayatSoalDosen"></div>
      </div>

      <!-- DASHBOARD REVIEWER -->
      <div id="reviewerView" class="content-card">
        <div class="d-flex justify-content-between align-items-center">
            <h2><i class="bi bi-person-video3"></i> Dashboard Reviewer</h2>
            <div class="d-flex align-items-center">
                <span id="userInfoReviewer"></span>
                <button class="btn btn-outline-danger btn-sm ms-3 logout-button"><i class="bi bi-box-arrow-right m-0"></i></button>
            </div>
        </div>
        <hr>
        <p class="text-muted">Ringkasan aktivitas dan daftar soal yang menunggu untuk direview sesuai peminatan Anda.</p>
        <div class="row g-4 my-4">
            <div class="col-md-3 col-6"><div class="stat-card"><i class="bi bi-hourglass-split stat-icon" style="color: var(--warning-color);"></i><div id="reviewerPendingCount" class="stat-value">...</div><div class="stat-label">Menunggu Review</div></div></div>
            <div class="col-md-3 col-6"><div class="stat-card"><i class="bi bi-journal-check stat-icon"></i><div id="reviewerTotalCount" class="stat-value">...</div><div class="stat-label">Total Direview</div></div></div>
            <div class="col-md-3 col-6"><div class="stat-card"><i class="bi bi-check-circle-fill stat-icon" style="color: var(--success-color);"></i><div id="reviewerDiterimaCount" class="stat-value">...</div><div class="stat-label">Diterima</div></div></div>
            <div class="col-md-3 col-6"><div class="stat-card"><i class="bi bi-x-circle-fill stat-icon" style="color: var(--danger-color);"></i><div id="reviewerDitolakCount" class="stat-value">...</div><div class="stat-label">Ditolak</div></div></div>
        </div>
        <hr>
        <div id="soalUntukReview" class="mt-4"></div>
      </div>

      <!-- DASHBOARD ADMIN -->
      <div id="adminView" class="content-card">
        <div class="d-flex justify-content-between align-items-center">
            <h2><i class="bi bi-person-gear"></i> Dashboard Admin</h2>
            <div class="d-flex align-items-center">
                <span id="userInfoAdmin"></span>
                <button class="btn btn-outline-danger btn-sm ms-3 logout-button"><i class="bi bi-box-arrow-right m-0"></i></button>
            </div>
        </div>
        <hr>
        <p class="text-muted">Ringkasan aktivitas sistem dan manajemen data master.</p>
        <!-- Admin Stats & Tools Section -->
        <div class="card admin-sub-card mb-5">
            <div class="card-body p-4">
                <div class="row g-4">
                    <div class="col-lg-8">
                        <h3 class="mt-2"><i class="bi bi-bar-chart-line-fill"></i> Statistik Keseluruhan</h3>
                        <div class="row g-3">
                            <div class="col-sm-6"><div class="stat-card clickable h-100" onclick="showBankSoal()"><i class="bi bi-archive-fill stat-icon"></i><div id="bankSoalCount" class="stat-value">...</div><div class="stat-label">Soal di Bank Soal</div></div></div>
                            <div class="col-sm-6"><div class="stat-card h-100"><i class="bi bi-people-fill stat-icon"></i><div id="totalUserCount" class="stat-value">...</div><div class="stat-label">Total User Terdaftar</div></div></div>
                        </div>
                        <h4 class="mt-4 h5 text-center text-muted">Rekapan Aktivitas</h4>
                        <div class="row g-3">
                            <div class="col-lg-4"><div class="table-responsive"><table class="table table-sm table-hover"><thead><tr><th>Peminatan</th><th>Soal</th></tr></thead><tbody id="rekapPeminatan"></tbody></table></div></div>
                            <div class="col-lg-4"><div class="table-responsive"><table class="table table-sm table-hover"><thead><tr><th>Nama Dosen</th><th>Soal</th></tr></thead><tbody id="rekapDosen"></tbody></table></div></div>
                            <div class="col-lg-4"><div class="table-responsive"><table class="table table-sm table-hover"><thead><tr><th>Reviewer</th><th><i class="bi bi-check-lg text-success"></i></th><th><i class="bi bi-x-lg text-danger"></i></th></tr></thead><tbody id="rekapReviewer"></tbody></table></div></div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <h3 class="mt-2"><i class="bi bi-tools"></i> Alat Admin</h3>
                        <div class="list-group">
                            <button type="button" class="list-group-item list-group-item-action" onclick="openUserModal(null, 'DOSEN')"><i class="bi bi-person-plus-fill me-2"></i> Tambah Dosen Baru</button>
                            <button type="button" class="list-group-item list-group-item-action" onclick="openUserModal(null, 'REVIEWER')"><i class="bi bi-person-video3 me-2"></i> Tambah Reviewer Baru</button>
                            <button type="button" id="btnDownloadTemplateAdmin" class="list-group-item list-group-item-action"><i class="bi bi-download me-2"></i> Download Template Soal</button>
                        </div>
                        <h3 class="mt-4"><i class="bi bi-box-seam"></i> Ekspor & Backup</h3>
                        <div class="list-group">
                             <button type="button" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" onclick="handleExport('excel', 'all', this)"><span><i class="bi bi-file-earmark-excel-fill text-success me-2"></i> Ekspor Bank Soal (Excel)</span><span class="spinner-border spinner-border-sm d-none"></span></button>
                             <button type="button" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" onclick="handleExport('pdf', 'all', this)"><span><i class="bi bi-file-earmark-pdf-fill text-danger me-2"></i> Ekspor Bank Soal (PDF)</span><span class="spinner-border spinner-border-sm d-none"></span></button>
                             <button type="button" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" onclick="handleBackup(this)"><span><i class="bi bi-database-down me-2"></i> Backup Seluruh Data (JSON)</span><span class="spinner-border spinner-border-sm d-none"></span></button>
                        </div>
                        <div class="card bg-light border-warning mt-4">
                            <div class="card-body">
                                <h5 class="card-title text-warning-emphasis"><i class="bi bi-exclamation-triangle-fill"></i> Restore Data</h5>
                                <p class="card-text small">Tindakan ini akan menimpa seluruh data yang ada. Gunakan dengan hati-hati.</p>
                                <form id="restoreForm">
                                    <div class="input-group">
                                        <input type="file" class="form-control form-control-sm" id="restoreFile" accept=".json" required>
                                        <button class="btn btn-sm btn-warning" type="submit"><i class="bi bi-database-up"></i></button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row g-4">
            <!-- User Management Section -->
            <div class="col-lg-8">
                <div class="card admin-sub-card h-100">
                    <div class="card-body p-4">
                        <h3 class="mb-4"><i class="bi bi-people-fill"></i> Manajemen User</h3>
                        <div class="table-responsive"><table class="table table-hover"><thead><tr><th>Nama</th><th>Email</th><th>Role</th><th>Peminatan</th><th>Aksi</th></tr></thead><tbody id="userList"></tbody></table></div>
                    </div>
                </div>
            </div>
            <!-- Peminatan Management Section -->
            <div class="col-lg-4">
                <div class="card admin-sub-card h-100">
                    <div class="card-body p-4">
                        <h3 class="mb-4"><i class="bi bi-tags-fill"></i> Manajemen Peminatan</h3>
                        <form id="peminatanForm" class="mb-3">
                            <div class="input-group">
                                <input type="text" id="peminatanId" class="form-control" placeholder="ID Peminatan (e.g. P01)" required>
                                <input type="text" id="peminatanNama" class="form-control" placeholder="Nama Peminatan" required>
                                <button class="btn btn-primary" type="submit"><i class="bi bi-plus-lg m-0"></i></button>
                            </div>
                        </form>
                        <div class="table-responsive">
                            <table class="table table-sm"><thead><tr><th>ID</th><th>Nama</th><th></th></tr></thead><tbody id="peminatanList"></tbody></table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

      </div>
    </main>

        <!-- FOOTER BARU DIMULAI DI SINI -->
    <footer class="app-footer">
      <div class="container-fluid text-center">
        <p class="mb-0">&copy; <span id="currentYear"></span> Poltekkes Kemenkes Kupang. develop by Mas Andy.</p>
      </div>
    </footer>
    <!-- FOOTER BARU BERAKHIR DI SINI -->
    
    <!-- BANK SOAL MODAL -->
    <div class="modal fade" id="bankSoalModal" tabindex="-1"><div class="modal-dialog modal-xl modal-dialog-scrollable"><div class="modal-content" style="border-radius: 1rem;"><div class="modal-header bg-light"><h5 class="modal-title h2" id="bankSoalModalLabel"><i class="bi bi-archive-fill me-2"></i> Bank Soal</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" id="bankSoalContent" style="background-color: var(--light-bg); padding: 1.5rem;"></div></div></div></div>

    <!-- USER MANAGEMENT MODAL (MODIFIED) -->
    <div class="modal fade" id="userModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content" style="border-radius: 1rem;"><form id="userForm"><div class="modal-header bg-light"><h5 class="modal-title h2" id="userModalLabel"></h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="hidden" id="userId" name="userId"><input type="hidden" id="userRole" name="userRole"><div class="mb-3"><label for="userNama" class="form-label">Nama Lengkap</label><input type="text" class="form-control" id="userNama" name="nama" required></div><div class="mb-3"><label for="userEmail" class="form-label">Email</label><input type="email" class="form-control" id="userEmail" name="email" required></div><div class="mb-3"><label for="userPassword" class="form-label">Password</label><input type="password" class="form-control" id="userPassword" name="password"><small class="form-text text-muted">Isi untuk menambah/mengubah. Kosongkan jika tidak ingin mengubah.</small></div>
    <!-- NEW: Peminatan Checkboxes -->
    <div class="mb-3">
        <label class="form-label">Peminatan</label>
        <div id="userPeminatanCheckboxes" class="p-2 border rounded" style="max-height: 150px; overflow-y: auto;">
            <!-- Checkboxes will be inserted here by JavaScript -->
        </div>
        <small class="form-text text-muted">Pilih satu atau lebih peminatan yang relevan.</small>
    </div>
    </div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button><button type="submit" class="btn btn-primary"><i class="bi bi-save"></i> Simpan</button></div></form></div></div></div>

    <!-- SOAL EDIT MODAL (NEW) -->
    <div class="modal fade" id="editSoalModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content" style="border-radius: 1rem;"><form id="editSoalForm"><div class="modal-header bg-light"><h5 class="modal-title h2"><i class="bi bi-pencil-square me-2"></i> Edit & Ajukan Ulang Soal</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body">
        <input type="hidden" id="editSoalId">
        <div class="row g-3">
            <div class="col-12"><label for="editPeminatanDosen" class="form-label">Peminatan</label><select id="editPeminatanDosen" class="form-select" required></select></div>
            <div class="col-12"><label for="editSoalText" class="form-label">Vignette / Teks Soal</label><textarea id="editSoalText" class="form-control" rows="4" placeholder="Tulis soal di sini..." required></textarea></div>
            <div class="col-md-6"><label for="editOpsiA" class="form-label">Opsi A</label><input type="text" id="editOpsiA" class="form-control" placeholder="Opsi A" required></div>
            <div class="col-md-6"><label for="editOpsiB" class="form-label">Opsi B</label><input type="text" id="editOpsiB" class="form-control" placeholder="Opsi B" required></div>
            <div class="col-md-6"><label for="editOpsiC" class="form-label">Opsi C</label><input type="text" id="editOpsiC" class="form-control" placeholder="Opsi C" required></div>
            <div class="col-md-6"><label for="editOpsiD" class="form-label">Opsi D</label><input type="text" id="editOpsiD" class="form-control" placeholder="Opsi D" required></div>
            <div class="col-md-6"><label for="editOpsiE" class="form-label">Opsi E</label><input type="text" id="editOpsiE" class="form-control" placeholder="Opsi E" required></div>
            <div class="col-md-6"><label for="editKunciJawaban" class="form-label">Kunci Jawaban</label><select id="editKunciJawaban" class="form-select" required><option value="" disabled selected>Pilih Kunci...</option><option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option><option value="E">E</option></select></div>
        </div>
    </div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button><button type="submit" class="btn btn-primary"><i class="bi bi-send-check"></i> Simpan & Ajukan Ulang</button></div></form></div></div></div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // PASTE URL SCRIPT ANDA DI SINI
      const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby3gv_dlo1-B2qV22SSA4Mpsnqeg2fX-gyU3mQnjFSARPB94VT5AjsBEaOlua1fnDH2/exec';
      
      let userModalInstance;
      let editSoalModalInstance; // New
      let allPeminatanList = []; // Store all peminatan for reuse
      
      async function callApi(action, payload, method = 'POST') {
        const spinner = document.getElementById("loginSpinner");
        if(spinner) spinner.style.display = 'block';
        try {
          const options = { method, mode: 'cors', headers: {} };
          let url = SCRIPT_URL;
          if (method === 'POST') {
              options.body = JSON.stringify({ action, payload });
          } else {
              const params = new URLSearchParams({ action, ...payload });
              url = `${SCRIPT_URL}?${params}`;
          }
          const response = await fetch(url, options);
          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
          return await response.json();
        } catch (error) {
          console.error("API call failed:", error);
          alert("Terjadi kesalahan koneksi ke server. Silakan cek konsol untuk detail.");
          throw error;
        } finally {
            if(spinner) spinner.style.display = 'none';
        }
      }
      
      function handleDownloadTemplate() {
          const headers = ["soal_text", "opsi_a", "opsi_b", "opsi_c", "opsi_d", "opsi_e", "kunci_jawaban", "id_peminatan"];
          const csvContent = "data:text/csv;charset=utf-8," + headers.join(",");
          const encodedUri = encodeURI(csvContent);
          const link = document.createElement("a");
          link.setAttribute("href", encodedUri);
          link.setAttribute("download", "template_soal.csv");
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
      }
      
      // Helper function to trigger file download from various data types
      function downloadFile(data, filename, mimeType) {
        let blob;
        if (mimeType.includes('pdf') && typeof data === 'string') { // Base64 PDF
            const byteCharacters = atob(data);
            const byteNumbers = new Array(byteCharacters.length);
            for (let i = 0; i < byteCharacters.length; i++) {
                byteNumbers[i] = byteCharacters.charCodeAt(i);
            }
            const byteArray = new Uint8Array(byteNumbers);
            blob = new Blob([byteArray], { type: mimeType });
        } else { // CSV, JSON
            blob = new Blob([data], { type: mimeType });
        }
        
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
      }

      document.addEventListener("DOMContentLoaded", function() {
        const mainContainer = document.getElementById("mainContainer");
        const bodyEl = document.body;
        const views = {
          loginView: document.getElementById("loginView"),
          dosenView: document.getElementById("dosenView"),
          reviewerView: document.getElementById("reviewerView"),
          adminView: document.getElementById("adminView")
        };

        function showView(viewName) {
            Object.values(views).forEach(view => view.style.display = 'none');
            if(views[viewName]) {
                views[viewName].style.display = 'block';
                if(viewName === 'loginView'){
                  mainContainer.className = 'container-login';
                  bodyEl.style.alignItems = 'center';
                  bodyEl.style.justifyContent = 'center';
                } else {
                  mainContainer.className = 'container-fluid py-4';
                  bodyEl.style.alignItems = 'flex-start';
                  bodyEl.style.justifyContent = 'center';
                }
            }
        }
        
        userModalInstance = new bootstrap.Modal(document.getElementById('userModal'));
        editSoalModalInstance = new bootstrap.Modal(document.getElementById('editSoalModal')); // New

        const loggedInUser = JSON.parse(sessionStorage.getItem("loggedInUser"));
        if (loggedInUser) {
          showDashboard(loggedInUser);
        } else {
          showView("loginView");
          setupSimpleLogin();
        }

        document.getElementById("btnMasuk").addEventListener("click", handleMasuk);
        document.querySelectorAll(".logout-button").forEach(btn => btn.addEventListener("click", handleLogout));
        document.getElementById("formSoal").addEventListener("submit", handleSubmitSoal);
        document.getElementById("editSoalForm").addEventListener("submit", handleUpdateSoalSubmit); // New
        document.getElementById("userForm").addEventListener("submit", handleUserFormSubmit);
        document.getElementById("btnDownloadTemplateDosen").addEventListener("click", handleDownloadTemplate);
        document.getElementById("btnDownloadTemplateAdmin").addEventListener("click", handleDownloadTemplate);
        document.getElementById("formUploadSoal").addEventListener("submit", handleSubmitUpload);
        const peminatanForm = document.getElementById("peminatanForm");
        if(peminatanForm) peminatanForm.addEventListener("submit", handlePeminatanFormSubmit);
        const restoreForm = document.getElementById("restoreForm");
        if(restoreForm) restoreForm.addEventListener("submit", handleRestoreSubmit);

        async function handleSubmitUpload(e) {
            e.preventDefault();
            const fileInput = document.getElementById('soalFileUpload');
            const file = fileInput.files[0];
            const submitBtn = e.target.querySelector('button[type="submit"]');
            if (!file) return alert("Silakan pilih file untuk diunggah.");
            
            submitBtn.disabled = true;
            submitBtn.innerHTML = `<span class="spinner-border spinner-border-sm"></span>`;

            const reader = new FileReader();
            reader.onload = async function(event) {
                const csvData = event.target.result;
                const rows = csvData.split('\n').filter(row => row.trim() !== '');
                if (rows.length < 2) {
                    alert("File CSV kosong atau hanya berisi header.");
                    resetUploadButton(); return;
                }
                const headers = rows.shift().split(',').map(h => h.trim().replace(/"/g, ''));
                const user = JSON.parse(sessionStorage.getItem("loggedInUser"));
                const regex = /,(?=(?:(?:[^"]*"){2})*[^"]*$)/;
                const soalDataArray = rows.map(row => {
                    const values = row.split(regex).map(v => v.trim().replace(/^"|"$/g, ''));
                    const soalObj = {};
                    headers.forEach((header, i) => { soalObj[header] = values[i]; });
                    soalObj.id_dosen_pembuat = user.userId;
                    return soalObj;
                });
                try {
                    const response = await callApi('submitBulkSoal', { soalDataArray });
                    alert(response.message);
                    if (response.success) {
                        fileInput.value = '';
                        loadRiwayatSoalDosen(user.userId);
                    }
                } catch(err) {
                    alert("Gagal mengunggah file. Pastikan format file sudah benar.");
                } finally { resetUploadButton(); }
            };
            reader.onerror = () => { alert("Gagal membaca file."); resetUploadButton(); };
            reader.readAsText(file);
            function resetUploadButton() {
                submitBtn.disabled = false;
                submitBtn.innerHTML = `<i class="bi bi-upload m-0"></i>`;
            }
        }
        
        function setupSimpleLogin() {
          const emailInput = document.getElementById("emailInput");
          const passwordInput = document.getElementById("passwordInput");
          const btnMasuk = document.getElementById("btnMasuk");
          function validateForm() {
            btnMasuk.disabled = !(emailInput.value.trim() !== '' && passwordInput.value.trim() !== '');
          }
          emailInput.addEventListener("input", validateForm);
          passwordInput.addEventListener("input", validateForm);
        }

        async function handleMasuk() {
            const email = document.getElementById("emailInput").value;
            const password = document.getElementById("passwordInput").value;
            if (!email || !password) return;
            
            document.getElementById("btnMasuk").disabled = true;
            const response = await callApi('loginUser', { loginData: { email, password } });

            if(response.success){
                sessionStorage.setItem("loggedInUser", JSON.stringify(response.user));
                showDashboard(response.user);
            } else {
                alert(response.message || "Login gagal.");
                document.getElementById("btnMasuk").disabled = false;
            }
        }

        function handleLogout() {
          sessionStorage.removeItem("loggedInUser");
          location.reload();
        }
        
        async function showDashboard(user) {
          const roleBadge = `<span class="badge rounded-pill role-badge">${user.role}</span>`;
          const userInfoHtml = `Halo, <strong>${user.nama}</strong> ${roleBadge}`;
          
          if (user.role === "DOSEN") {
            showView("dosenView");
            document.getElementById('userInfoDosen').innerHTML = userInfoHtml;
            document.getElementById('namaDosen').value = user.nama;
            await loadPeminatanForDosen(user.peminatan); // Await this to ensure list is loaded
            loadRiwayatSoalDosen(user.userId);
          } else if (user.role === "REVIEWER") {
            showView("reviewerView");
            document.getElementById('userInfoReviewer').innerHTML = userInfoHtml;
            loadReviewerDashboard(user);
          } else if (user.role === "ADMIN") {
            showView("adminView");
            document.getElementById('userInfoAdmin').innerHTML = userInfoHtml;
            loadAdminDashboard();
          }
        }

        async function populatePeminatanSelect(selectId, userPeminatanStr) {
            const userPeminatanIds = userPeminatanStr ? userPeminatanStr.split(',') : [];
            if (allPeminatanList.length === 0) {
                const response = await callApi('getPeminatanList', {}, 'GET');
                if(response) allPeminatanList = response;
            }
            
            const select = document.getElementById(selectId);
            select.innerHTML = '<option value="" selected disabled>Pilih peminatan...</option>';
            const filteredPeminatan = allPeminatanList.filter(p => userPeminatanIds.includes(p.id.toString()));
            
            if (filteredPeminatan.length > 0) {
                filteredPeminatan.forEach(p => {
                    select.innerHTML += `<option value="${p.id}">${p.nama}</option>`;
                });
                select.disabled = false;
            } else {
                select.innerHTML = '<option value="" disabled selected>Anda tidak terdaftar pada peminatan manapun.</option>';
                select.disabled = true;
            }
        }

        async function loadPeminatanForDosen(userPeminatanStr) {
          await populatePeminatanSelect('peminatanDosen', userPeminatanStr);
          const select = document.getElementById('peminatanDosen');
          document.querySelector('#formSoal button[type="submit"]').disabled = select.disabled;
        }
        
        async function handleSubmitSoal(e) {
          e.preventDefault();
          const user = JSON.parse(sessionStorage.getItem("loggedInUser"));
          const soalData = {
              soal_text: document.getElementById("soalText").value, opsi_a: document.getElementById("opsiA").value,
              opsi_b: document.getElementById("opsiB").value, opsi_c: document.getElementById("opsiC").value,
              opsi_d: document.getElementById("opsiD").value, opsi_e: document.getElementById("opsiE").value,
              kunci_jawaban: document.getElementById("kunciJawaban").value, id_peminatan: document.getElementById("peminatanDosen").value,
              id_dosen_pembuat: user.userId
          };
          if (!soalData.id_peminatan || !soalData.kunci_jawaban) return alert("Peminatan dan Kunci Jawaban wajib dipilih.");

          const submitBtn = e.target.querySelector('button[type="submit"]');
          submitBtn.disabled = true;
          submitBtn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Mengirim...`;
          
          const response = await callApi('submitSoal', { soalData });
          alert(response.message);
          if (response.success) {
            document.getElementById("formSoal").reset();
            document.getElementById('namaDosen').value = user.nama;
            loadRiwayatSoalDosen(user.userId);
          }
          submitBtn.disabled = false;
          submitBtn.innerHTML = `<i class="bi bi-send-check"></i> Kirim Soal`;
        }
        
        async function loadRiwayatSoalDosen(dosenId) {
            const container = document.getElementById("riwayatSoalDosen");
            container.innerHTML = '<div class="text-center"><div class="spinner-border text-secondary" role="status"></div></div>';
            document.getElementById("dosenStatSection").style.display = 'block';
            
            const soalList = await callApi('getSoalByDosen', { dosenId }, 'GET');
            document.getElementById("dosenTotalCount").textContent = soalList.length;
            document.getElementById("dosenDiterimaCount").textContent = soalList.filter(s => s.status === 'DITERIMA').length;
            document.getElementById("dosenDitolakCount").textContent = soalList.filter(s => s.status === 'DITOLAK').length;

            if (!soalList || soalList.length === 0) {
              container.innerHTML = '<div class="alert alert-light text-center border">Anda belum pernah mengajukan soal.</div>';
              return;
            }
            let html = '<div class="table-responsive"><table class="table table-striped table-hover"><thead><tr><th>Soal</th><th>Status</th><th>Catatan Reviewer</th><th>Aksi</th></tr></thead><tbody>';
            soalList.slice().reverse().forEach(soal => {
              let statusBadge = '';
              switch(soal.status) {
                case 'DITERIMA': statusBadge = '<span class="badge bg-success">DITERIMA</span>'; break;
                case 'DITOLAK': statusBadge = '<span class="badge bg-danger">DITOLAK</span>'; break;
                case 'MENUNGGU_REVIEW': statusBadge = '<span class="badge bg-warning text-dark">MENUNGGU REVIEW</span>'; break;
                default: statusBadge = `<span class="badge bg-secondary">${soal.status}</span>`;
              }
              let aksiHtml = '-';
              if (soal.status === 'DITOLAK') {
                  const soalJsonString = JSON.stringify(soal).replace(/'/g, "\\'");
                  aksiHtml = `<button class="btn btn-sm btn-warning py-1" onclick='openEditSoalModal(${soalJsonString})'><i class="bi bi-pencil-square" style="margin-right: 0.2rem;"></i> Edit & Kirim Ulang</button>`;
              }
              html += `<tr><td>${soal.soal_text.substring(0, 70)}...</td><td>${statusBadge}</td><td>${soal.catatan_reviewer || '-'}</td><td>${aksiHtml}</td></tr>`;
            });
            container.innerHTML = html + '</tbody></table></div>';
        }

        window.openEditSoalModal = async function(soal) {
          document.getElementById('editSoalId').value = soal.id_soal;
          document.getElementById('editSoalText').value = soal.soal_text;
          document.getElementById('editOpsiA').value = soal.opsi_a;
          document.getElementById('editOpsiB').value = soal.opsi_b;
          document.getElementById('editOpsiC').value = soal.opsi_c;
          document.getElementById('editOpsiD').value = soal.opsi_d;
          document.getElementById('editOpsiE').value = soal.opsi_e;
          document.getElementById('editKunciJawaban').value = soal.kunci_jawaban;
          
          const user = JSON.parse(sessionStorage.getItem("loggedInUser"));
          await populatePeminatanSelect('editPeminatanDosen', user.peminatan);
          document.getElementById('editPeminatanDosen').value = soal.id_peminatan;

          editSoalModalInstance.show();
        }

        async function handleUpdateSoalSubmit(e) {
            e.preventDefault();
            const user = JSON.parse(sessionStorage.getItem("loggedInUser"));
            const soalData = {
                id_soal: document.getElementById("editSoalId").value,
                soal_text: document.getElementById("editSoalText").value,
                opsi_a: document.getElementById("editOpsiA").value,
                opsi_b: document.getElementById("editOpsiB").value,
                opsi_c: document.getElementById("editOpsiC").value,
                opsi_d: document.getElementById("editOpsiD").value,
                opsi_e: document.getElementById("editOpsiE").value,
                kunci_jawaban: document.getElementById("editKunciJawaban").value,
                id_peminatan: document.getElementById("editPeminatanDosen").value,
            };

            const submitBtn = e.target.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Mengirim Ulang...`;
            
            const response = await callApi('resubmitSoal', { soalData });
            alert(response.message);
            if (response.success) {
              editSoalModalInstance.hide();
              loadRiwayatSoalDosen(user.userId);
            }
            submitBtn.disabled = false;
            submitBtn.innerHTML = `<i class="bi bi-send-check"></i> Simpan & Ajukan Ulang`;
        }


        async function loadReviewerDashboard(user) {
            const peminatanIds = user.peminatan || '';
            const stats = await callApi('getReviewerStats', { reviewerId: user.userId }, 'GET');
            if (stats) {
                document.getElementById("reviewerPendingCount").textContent = stats.pendingReview;
                document.getElementById("reviewerTotalCount").textContent = stats.totalReviewed;
                document.getElementById("reviewerDiterimaCount").textContent = stats.totalAccepted;
                document.getElementById("reviewerDitolakCount").textContent = stats.totalRejected;
            }
            loadSoalForReviewer(peminatanIds);
        }

        async function loadSoalForReviewer(peminatanIdsStr) {
          const soalList = await callApi('getSoalForReviewer', { peminatanIds: peminatanIdsStr }, 'GET');
          const container = document.getElementById("soalUntukReview");
          if (!soalList || soalList.length === 0) {
            container.innerHTML = '<div class="alert alert-info text-center"><i class="bi bi-emoji-sunglasses"></i> Tidak ada soal yang perlu direview pada peminatan Anda saat ini.</div>';
            return;
          }
          container.innerHTML = soalList.map(soal => `
            <div class="card reviewer-card mb-4" id="card_${soal.id_soal}">
              <div class="card-header d-flex justify-content-between">
                <span>Soal dari: <strong>${soal.nama_dosen_pembuat}</strong></span>
                <span class="badge bg-primary align-self-center">${soal.nama_peminatan}</span>
              </div>
              <div class="card-body">
                <p class="card-text bg-light p-3 rounded" style="white-space: pre-wrap;">${soal.soal_text}</p>
                <ul class="list-group list-group-flush mb-3">
                  ${['a','b','c','d','e'].map(opt => `<li class="list-group-item ${soal.kunci_jawaban.toUpperCase() === opt.toUpperCase() ? 'correct-answer' : ''}"><strong>${opt.toUpperCase()}:</strong> ${soal['opsi_'+opt]}</li>`).join('')}
                </ul>
                <p><strong>Kunci Jawaban: ${soal.kunci_jawaban.toUpperCase()}</strong></p><hr>
                <div class="mb-3"><textarea class="form-control" id="catatan_${soal.id_soal}" rows="2" placeholder="Catatan Review (Wajib jika ditolak)"></textarea></div>
                <div class="d-flex justify-content-end gap-2">
                  <button class="btn btn-danger" onclick="handleReview('${soal.id_soal}', 'DITOLAK', this)"><i class="bi bi-x-circle"></i> Tolak</button>
                  <button class="btn btn-success" onclick="handleReview('${soal.id_soal}', 'DITERIMA', this)"><i class="bi bi-check-circle"></i> Terima</button>
                </div>
              </div>
            </div>`).join('');
        }

        window.handleReview = async function(id_soal, status, buttonElement) {
            const user = JSON.parse(sessionStorage.getItem("loggedInUser"));
            const catatan = document.getElementById(`catatan_${id_soal}`).value;
            if (status === 'DITOLAK' && !catatan.trim()) return alert("Catatan wajib diisi jika menolak soal.");
            const buttonContainer = buttonElement.parentElement;
            buttonContainer.querySelectorAll('.btn').forEach(btn => btn.disabled = true);
            buttonElement.innerHTML = `<span class="spinner-border spinner-border-sm"></span>`;
            const reviewData = { id_soal, status, catatan, id_reviewer: user.userId };
            const response = await callApi('processReview', { reviewData });
            alert(response.message);
            if (response.success) {
              const cardToRemove = document.getElementById(`card_${id_soal}`);
              cardToRemove.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
              cardToRemove.style.opacity = '0'; cardToRemove.style.transform = 'scale(0.95)';
              setTimeout(() => {
                cardToRemove.remove();
                if (document.getElementById("soalUntukReview").children.length === 0) {
                  loadSoalForReviewer(user.peminatan);
                }
                loadReviewerDashboard(user);
              }, 500);
            } else {
               buttonContainer.querySelectorAll('.btn').forEach(btn => btn.disabled = false);
               buttonContainer.querySelector('.btn-success').innerHTML = '<i class="bi bi-check-circle"></i> Terima';
               buttonContainer.querySelector('.btn-danger').innerHTML = '<i class="bi bi-x-circle"></i> Tolak';
            }
        }
        
        async function loadAdminDashboard() {
            const data = await callApi('getAdminDashboardData', {}, 'GET');
            if (data) {
                allPeminatanList = data.peminatan || []; // Store peminatan list
                populateAdminStats(data.stats);
                populateUserTables(data.users);
                populateAdminPeminatanList(data.peminatan);
            }
        }

        function populateAdminStats(stats) {
          if (!stats) return;
          document.getElementById('bankSoalCount').textContent = stats.bankSoalCount || 0;
          
          const rekapDosenBody = document.getElementById('rekapDosen');
          rekapDosenBody.innerHTML = Object.keys(stats.soalPerDosen).length > 0 ?
            Object.entries(stats.soalPerDosen).map(([dosen, count]) => `<tr><td>${dosen.split(" ")[0]}</td><td>${count}</td></tr>`).join('') :
            '<tr><td colspan="2" class="text-center text-muted">-</td></tr>';
          
          const rekapReviewerBody = document.getElementById('rekapReviewer');
          rekapReviewerBody.innerHTML = Object.keys(stats.reviewPerReviewer).length > 0 ?
            Object.values(stats.reviewPerReviewer).map(data => `<tr><td>${data.nama.split(" ")[0]}</td><td>${data.diterima}</td><td>${data.ditolak}</td></tr>`).join('') :
            '<tr><td colspan="3" class="text-center text-muted">-</td></tr>';

          const rekapPeminatanBody = document.getElementById('rekapPeminatan');
          rekapPeminatanBody.innerHTML = stats.soalPerPeminatan && Object.keys(stats.soalPerPeminatan).length > 0 ?
            Object.entries(stats.soalPerPeminatan).map(([peminatan, count]) => `<tr><td>${peminatan}</td><td>${count}</td></tr>`).join('') :
            '<tr><td colspan="2" class="text-center text-muted">-</td></tr>';
        }

        function populateUserTables(users) {
            if (!users) return;
            document.getElementById('totalUserCount').textContent = users.length || 0;
            const userListBody = document.getElementById('userList');
            userListBody.innerHTML = '';
          
            users.forEach(user => {
                const peminatanBadges = (user.peminatan || '').split(',').filter(Boolean).map(p => `<span class="badge bg-secondary me-1">${p}</span>`).join('') || '-';
                const row = `<tr>
                  <td>${user.nama}</td>
                  <td>${user.email || '-'}</td>
                  <td><span class="badge bg-info text-dark">${user.role}</span></td>
                  <td>${peminatanBadges}</td>
                  <td>
                    <button class="btn btn-sm btn-outline-primary py-1 px-2" onclick='openUserModal(${JSON.stringify(user)}, "${user.role}")'><i class="bi bi-pencil-square"></i></button>
                    <button class="btn btn-sm btn-outline-danger py-1 px-2" onclick="handleDeleteUser('${user.userId}', '${user.nama}')"><i class="bi bi-trash"></i></button>
                  </td></tr>`;
                userListBody.innerHTML += row;
            });
        }
        
        function populateAdminPeminatanList(peminatanList) {
            const listContainer = document.getElementById('peminatanList');
            if (!peminatanList) {
                listContainer.innerHTML = '<tr><td colspan="3" class="text-center text-muted">Gagal memuat data.</td></tr>';
                return;
            }
            listContainer.innerHTML = peminatanList.map(p => `
                <tr>
                    <td><span class="badge bg-primary">${p.id}</span></td>
                    <td>${p.nama}</td>
                    <td class="text-end"><button class="btn btn-sm btn-outline-danger p-0 px-2" onclick="handleDeletePeminatan('${p.id}', '${p.nama}')"><i class="bi bi-x-lg"></i></button></td>
                </tr>
            `).join('');
        }
        
        async function handlePeminatanFormSubmit(e) {
            e.preventDefault();
            const id = document.getElementById('peminatanId').value.trim();
            const nama = document.getElementById('peminatanNama').value.trim();
            if(!id || !nama) return;

            const submitBtn = e.target.querySelector('button[type="submit"]');
            submitBtn.disabled = true;

            const response = await callApi('addPeminatan', { peminatanData: { id, nama } });
            alert(response.message);
            if (response.success) {
                e.target.reset();
                loadAdminDashboard(); 
            }
            submitBtn.disabled = false;
        }

        window.handleDeletePeminatan = async function(id, nama) {
            if (confirm(`Yakin ingin menghapus peminatan "${nama}" (${id})?`)) {
                const response = await callApi('deletePeminatan', { peminatanId: id });
                alert(response.message);
                if (response.success) loadAdminDashboard();
            }
        }

        window.openUserModal = function(user, role) {
          const form = document.getElementById('userForm');
          form.reset();
          document.getElementById('userRole').value = role;
          const label = document.getElementById('userModalLabel');
          label.innerHTML = `<i class="bi ${role === 'DOSEN' ? 'bi-person-plus-fill' : 'bi-person-video3'} me-2"></i>`;
          
          const checkboxContainer = document.getElementById('userPeminatanCheckboxes');
          checkboxContainer.innerHTML = '';
          const userPeminatan = user ? (user.peminatan || '').split(',') : [];
          allPeminatanList.forEach(p => {
              const isChecked = userPeminatan.includes(p.id.toString());
              checkboxContainer.innerHTML += `
                  <div class="form-check">
                      <input class="form-check-input" type="checkbox" value="${p.id}" id="peminatan_check_${p.id}" ${isChecked ? 'checked' : ''}>
                      <label class="form-check-label" for="peminatan_check_${p.id}">${p.nama} (${p.id})</label>
                  </div>`;
          });

          if (user) { // Edit mode
            label.innerHTML += `Edit Data ${role.charAt(0).toUpperCase() + role.slice(1).toLowerCase()}`;
            document.getElementById('userId').value = user.userId;
            document.getElementById('userNama').value = user.nama;
            document.getElementById('userEmail').value = user.email || '';
            document.getElementById('userPassword').placeholder = "Kosongkan jika tidak diubah";
            document.getElementById('userPassword').required = false;
          } else { // Add mode
            label.innerHTML += `Tambah ${role.charAt(0).toUpperCase() + role.slice(1).toLowerCase()} Baru`;
            document.getElementById('userId').value = '';
            document.getElementById('userPassword').placeholder = "Password wajib diisi";
            document.getElementById('userPassword').required = true;
          }
          userModalInstance.show();
        }

        async function handleUserFormSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.disabled = true;

            const selectedPeminatan = Array.from(document.querySelectorAll('#userPeminatanCheckboxes .form-check-input:checked'))
                                       .map(cb => cb.value)
                                       .join(',');

            const userData = {
                userId: form.userId.value,
                nama: form.userNama.value,
                email: form.userEmail.value,
                role: form.userRole.value,
                password: form.userPassword.value,
                peminatan: selectedPeminatan,
            };
            
            const action = userData.userId ? 'updateUser' : 'addUser';
            if(action === 'addUser' && !userData.password){
                alert("Password wajib diisi untuk user baru.");
                submitBtn.disabled = false; return;
            }

            try {
                const response = await callApi(action, { userData });
                alert(response.message);
                if(response.success) {
                    userModalInstance.hide();
                    loadAdminDashboard(); 
                }
            } catch(error) { console.error(error); } 
            finally { submitBtn.disabled = false; }
        }
        
        window.handleDeleteUser = async function(userId, userName) {
            if (confirm(`Yakin ingin menghapus user "${userName}"?`)) {
                const response = await callApi('deleteUser', { userId });
                alert(response.message);
                if (response.success) loadAdminDashboard();
            }
        }
        
        // --- ADMIN EXPORT, BACKUP, RESTORE ---
        window.handleExport = async function(format, peminatanId, button) {
            const spinner = button.querySelector('.spinner-border');
            spinner.classList.remove('d-none');
            button.disabled = true;
            try {
                const response = await callApi('exportSoal', { format, peminatanId });
                if(response.success){
                    downloadFile(response.fileData, response.fileName, response.mimeType);
                } else {
                    alert(response.message || "Gagal melakukan ekspor.");
                }
            } catch(e) {
                alert("Terjadi kesalahan saat ekspor.");
            } finally {
                spinner.classList.add('d-none');
                button.disabled = false;
            }
        }
        
        window.handleBackup = async function(button) {
            const spinner = button.querySelector('.spinner-border');
            spinner.classList.remove('d-none');
            button.disabled = true;
            try {
                const response = await callApi('backupData', {});
                if(response.success){
                    const timestamp = new Date().toISOString().slice(0, 19).replace(/[-:T]/g, "");
                    const filename = `simivig_backup_${timestamp}.json`;
                    downloadFile(response.backupData, filename, 'application/json');
                } else {
                    alert(response.message || "Gagal melakukan backup.");
                }
            } catch(e) {
                alert("Terjadi kesalahan saat backup.");
            } finally {
                spinner.classList.add('d-none');
                button.disabled = false;
            }
        }
        
        async function handleRestoreSubmit(e) {
            e.preventDefault();
            const fileInput = document.getElementById('restoreFile');
            const file = fileInput.files[0];
            const button = e.target.querySelector('button[type="submit"]');
            if(!file) return alert("Silakan pilih file backup (.json) untuk di-restore.");
            
            const confirmation = prompt("PERINGATAN! Tindakan ini akan MENGHAPUS SEMUA DATA saat ini dan menggantinya dengan data dari file backup. Ketik 'RESTORE' untuk melanjutkan.");
            if (confirmation !== 'RESTORE') {
                fileInput.value = '';
                return alert("Proses restore dibatalkan.");
            }
            
            button.disabled = true;
            button.innerHTML = `<span class="spinner-border spinner-border-sm"></span>`;
            
            const reader = new FileReader();
            reader.onload = async (event) => {
                try {
                    const backupData = JSON.parse(event.target.result);
                    const response = await callApi('restoreData', { backupData });
                    alert(response.message);
                    if(response.success) location.reload(); // Reload to show new data
                } catch (err) {
                    console.error(err);
                    alert("Gagal memproses file backup. Pastikan file valid. " + err.message);
                } finally {
                    button.disabled = false;
                    button.innerHTML = `<i class="bi bi-database-up"></i>`;
                    fileInput.value = '';
                }
            };
            reader.onerror = () => {
                alert("Gagal membaca file.");
                button.disabled = false;
                button.innerHTML = `<i class="bi bi-database-up"></i>`;
            };
            reader.readAsText(file);
        }

        let bankSoalModalInstance;
        window.showBankSoal = async function() {
            if (!bankSoalModalInstance) bankSoalModalInstance = new bootstrap.Modal(document.getElementById('bankSoalModal'));
            const modalBody = document.getElementById('bankSoalContent');
            modalBody.innerHTML = '<div class="text-center p-5"><div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status"></div></div>';
            bankSoalModalInstance.show();

            const bankSoalList = await callApi('getBankSoal', {}, 'GET');

            if (!allPeminatanList || allPeminatanList.length === 0) {
                modalBody.innerHTML = '<div class="alert alert-warning text-center m-3">Data Peminatan tidak ditemukan.</div>';
                return;
            }
            
            let tabHtml = '';
            let contentHtml = '';
            
            const renderSoalContent = (soalList, peminatanId, peminatanNama) => {
                const header = `
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4 class="mb-0">Daftar Soal - ${peminatanNama}</h4>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-success" onclick="handleExport('excel', '${peminatanId}', this)"><i class="bi bi-file-earmark-excel-fill me-1"></i> Excel <span class="spinner-border spinner-border-sm d-none"></span></button>
                            <button class="btn btn-outline-danger" onclick="handleExport('pdf', '${peminatanId}', this)"><i class="bi bi-file-earmark-pdf-fill me-1"></i> PDF <span class="spinner-border spinner-border-sm d-none"></span></button>
                        </div>
                    </div>`;

                if (soalList.length === 0) {
                    return header + '<div class="alert alert-info text-center m-3">Bank Soal masih kosong untuk kategori ini.</div>';
                }
                const soalCards = soalList.map((soal, s_index) => {
                    const peminatanInfo = allPeminatanList.find(p => p.id.toString() === soal.id_peminatan.toString());
                    const peminatanBadge = peminatanInfo && peminatanId === 'all' ? `<span class="badge bg-primary">${peminatanInfo.nama}</span>` : '';
                    return `
                    <div class="card reviewer-card mb-3">
                      <div class="card-header d-flex justify-content-between">
                        <span>Soal #${s_index + 1} (Dari: ${soal.nama_dosen_pembuat})</span>
                        ${peminatanBadge}
                      </div>
                      <div class="card-body">
                        <p class="card-text bg-light p-3 rounded" style="white-space: pre-wrap;">${soal.soal_text}</p>
                        <ul class="list-group list-group-flush">${['a','b','c','d','e'].map(opt => `<li class="list-group-item ${soal.kunci_jawaban.toUpperCase() === opt.toUpperCase() ? 'correct-answer' : ''}"><strong>${opt.toUpperCase()}:</strong> ${soal['opsi_'+opt] || ''}</li>`).join('')}</ul>
                      </div>
                    </div>`;
                }).join('');
                return header + soalCards;
            };

            // "All Peminatan" Tab
            const allSoalCount = bankSoalList.length;
            tabHtml += `<button class="nav-link text-start active" id="peminatan-tab-all" data-bs-toggle="pill" data-bs-target="#peminatan-content-all" type="button" role="tab" aria-selected="true">Semua Peminatan <span class="badge bg-primary rounded-pill ms-1">${allSoalCount}</span></button>`;
            contentHtml += `<div class="tab-pane fade show active" id="peminatan-content-all" role="tabpanel" tabindex="0">${renderSoalContent(bankSoalList, 'all', 'Semua Peminatan')}</div>`;

            // Individual Peminatan Tabs
            allPeminatanList.forEach((peminatan) => {
                const soalForPeminatan = bankSoalList.filter(s => s.id_peminatan.toString() === peminatan.id.toString());
                const count = soalForPeminatan.length;
                tabHtml += `<button class="nav-link text-start" id="peminatan-tab-${peminatan.id}" data-bs-toggle="pill" data-bs-target="#peminatan-content-${peminatan.id}" type="button" role="tab" aria-selected="false">${peminatan.nama} <span class="badge bg-secondary rounded-pill ms-1">${count}</span></button>`;
                contentHtml += `<div class="tab-pane fade" id="peminatan-content-${peminatan.id}" role="tabpanel" tabindex="0">${renderSoalContent(soalForPeminatan, peminatan.id, peminatan.nama)}</div>`;
            });

            modalBody.innerHTML = `
                <div class="d-flex align-items-start">
                    <div class="nav flex-column nav-pills me-3" id="v-pills-tab" role="tablist" aria-orientation="vertical" style="min-width: 200px;">${tabHtml}</div>
                    <div class="tab-content flex-grow-1" id="v-pills-tabContent">${contentHtml}</div>
                </div>`;
        }
      });
    </script>
<script>
      document.getElementById('currentYear').textContent = new Date().getFullYear();
    </script>

  </body>
</html>
