<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Ukom Soal Review</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Internal CSS -->
    <style>
      :root {
        --primary-blue: #0d6efd;
        --primary-blue-hover: #0b5ed7;
        --secondary-blue: #e7f1ff;
        --light-bg: #f7f9fc;
        --dark-text: #212529;
        --gray-text: #6c757d;
        --border-color: #dee2e6;
        --success-color: #198754;
        --danger-color: #dc3545;
        --warning-color: #ffc107;
        --white-color: #fff;
        --shadow: 0 10px 30px rgba(0, 0, 0, 0.07);
        --shadow-sm: 0 4px 15px rgba(0, 0, 0, 0.05);
      }

      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(15px); }
        to { opacity: 1; transform: translateY(0); }
      }

      body { 
        background-color: var(--light-bg); 
        font-family: 'Inter', sans-serif;
        color: var(--dark-text);
        display: flex;
        min-height: 100vh;
        align-items: center;
        justify-content: center;
      }

      #mainContainer {
        width: 100%;
        transition: max-width 0.3s ease-in-out;
      }
      .container-login { max-width: 480px; }

      .content-card {
        display: none; 
        padding: 2.5rem; 
        background-color: var(--white-color); 
        border-radius: 1rem; 
        border: 1px solid var(--border-color);
        box-shadow: var(--shadow);
        animation: fadeIn 0.5s ease-out forwards;
      }

      /* User Info & Role Badge in Dashboard Header */
      #userInfoDosen, #userInfoReviewer, #userInfoAdmin, .role-badge {
        font-weight: 500;
      }
      .role-badge {
        font-size: 0.75rem;
        padding: 0.3em 0.6em;
        vertical-align: middle;
        margin-left: 8px;
        background-color: var(--secondary-blue);
        color: var(--primary-blue);
        border: 1px solid var(--primary-blue);
      }
      
      /* FORM ELEMENTS STYLING */
      .form-label { font-weight: 500; color: var(--gray-text); }
      .form-control, .form-select {
        border-radius: 0.5rem; padding: 0.75rem 1rem;
        border: 1px solid var(--border-color);
        transition: border-color .2s ease-in-out, box-shadow .2s ease-in-out;
      }
      .form-control:focus, .form-select:focus {
        border-color: var(--primary-blue);
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.15);
      }

      h2, h3 { color: var(--dark-text); font-weight: 600; display: flex; align-items: center; gap: 0.75rem;}
      h2 .bi, h3 .bi { font-size: 1.1em; color: var(--primary-blue);}

      /* BUTTONS */
      .btn { border-radius: 0.5rem; padding: 0.6rem 1.25rem; font-weight: 600; transition: all 0.2s ease; }
      .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.08); }
      .btn-primary { background-color: var(--primary-blue); border-color: var(--primary-blue); }
      .btn-primary:hover { background-color: var(--primary-blue-hover); border-color: var(--primary-blue-hover); }
      .btn .bi { margin-right: 0.5rem; vertical-align: -2px;}

      /* TABLES */
      .table { vertical-align: middle; }
      .table > :not(caption) > * > * { padding: 1rem; }
      .table thead th { 
        background-color: var(--light-bg); color: var(--dark-text); 
        font-weight: 600; border-bottom: 2px solid var(--primary-blue);
      }
      .table-hover > tbody > tr:hover > * {
        background-color: var(--secondary-blue);
      }
      
      /* REVIEWER CARD */
      .reviewer-card {
        border: 1px solid var(--border-color); border-radius: 0.75rem; box-shadow: var(--shadow-sm);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        border-left: 4px solid var(--primary-blue);
      }
      .reviewer-card:hover { transform: translateY(-4px); box-shadow: var(--shadow); }
      .reviewer-card .card-header {
        background-color: var(--secondary-blue); border-bottom: 1px solid var(--border-color);
        font-weight: 600; color: var(--primary-blue);
        border-radius: 0.75rem 0.75rem 0 0;
      }
      .reviewer-card .list-group-item.correct-answer {
        background-color: #d1e7dd; color: #0f5132;
        font-weight: 600; border-color: rgba(0,0,0,0.05);
      }

      /* STAT CARDS */
      .stat-card {
        background-color: var(--white-color); border-radius: 0.75rem;
        padding: 1.5rem; border: 1px solid var(--border-color);
        box-shadow: var(--shadow-sm); text-align: center;
        transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
      }
      .stat-card .stat-icon {
        font-size: 2.2rem; margin-bottom: 0.75rem; color: var(--primary-blue); display: block;
      }
      .stat-card .stat-value { font-size: 2rem; font-weight: 700; color: var(--dark-text); }
      .stat-card .stat-label { font-size: 0.9rem; color: var(--gray-text); font-weight: 500; }
      .stat-card.clickable { cursor: pointer; }
      .stat-card.clickable:hover {
        transform: translateY(-5px); box-shadow: var(--shadow); border-color: var(--primary-blue);
      }

      /* ADMIN DASHBOARD CARDS */
      .admin-sub-card {
        border: 1px solid var(--border-color);
        border-radius: 0.75rem;
        box-shadow: var(--shadow-sm);
      }
    </style>
  </head>
  <body>

    <main id="mainContainer" class="container-login">
      <!-- HALAMAN LOGIN (MODIFIED for EMAIL) -->
      <div id="loginView" class="content-card text-center">
        <i class="bi bi-shield-lock" style="font-size: 3.5rem; color: var(--primary-blue);"></i>
        <h2 class="mt-3 justify-content-center">Selamat Datang</h2>
        <p class="text-muted mb-4">Silakan masuk untuk melanjutkan ke dashboard.</p>
        <div class="mb-3 text-start">
          <label for="emailInput" class="form-label">Email</label>
          <input type="email" id="emailInput" class="form-control" placeholder="Masukkan email Anda" autocomplete="email">
        </div>
        <div class="mb-3 text-start">
          <label for="passwordInput" class="form-label">Password</label>
          <input type="password" id="passwordInput" class="form-control" placeholder="Masukkan password Anda" autocomplete="current-password">
        </div>
        <button id="btnMasuk" class="btn btn-primary w-100 mt-3" disabled><i class="bi bi-box-arrow-in-right"></i> Masuk</button>
        <div id="loginSpinner" class="text-center mt-3" style="display:none;">
          <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>
        </div>
      </div>

      <!-- DASHBOARD DOSEN -->
      <div id="dosenView" class="content-card">
        <div class="d-flex justify-content-between align-items-center">
            <h2><i class="bi bi-person-workspace"></i> Dashboard Dosen</h2>
            <div class="d-flex align-items-center">
                <span id="userInfoDosen"></span>
                <button class="btn btn-outline-danger btn-sm ms-3 logout-button"><i class="bi bi-box-arrow-right m-0"></i></button>
            </div>
        </div>
        <hr>
        <div class="row g-5">
            <div class="col-lg-6">
                <h3 class="mt-4"><i class="bi bi-file-earmark-arrow-up-fill"></i> Upload Soal via Template</h3>
                <p class="text-muted">Untuk input banyak soal sekaligus, unduh template, isi, lalu unggah kembali.</p>
                <div class="card p-3 bg-light border">
                    <div class="row align-items-center g-2">
                        <div class="col-md-5"><button id="btnDownloadTemplateDosen" class="btn btn-success w-100"><i class="bi bi-download"></i> Download</button></div>
                        <div class="col-md-7">
                            <form id="formUploadSoal">
                                <div class="input-group"><input type="file" class="form-control" id="soalFileUpload" accept=".csv" required><button class="btn btn-primary" type="submit" title="Upload File"><i class="bi bi-upload m-0"></i></button></div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <h3 class="mt-4"><i class="bi bi-pencil-square"></i> Input Soal Manual</h3>
                 <form id="formSoal">
                    <div class="row g-3">
                        <div class="col-12"><input type="text" id="namaDosen" class="form-control" readonly></div>
                        <div class="col-12"><select id="peminatanDosen" class="form-select" required></select></div>
                        <div class="col-12"><textarea id="soalText" class="form-control" rows="3" placeholder="Tulis soal di sini..." required></textarea></div>
                        <div class="col-md-6"><input type="text" id="opsiA" class="form-control" placeholder="Opsi A" required></div>
                        <div class="col-md-6"><input type="text" id="opsiB" class="form-control" placeholder="Opsi B" required></div>
                        <div class="col-md-6"><input type="text" id="opsiC" class="form-control" placeholder="Opsi C" required></div>
                        <div class="col-md-6"><input type="text" id="opsiD" class="form-control" placeholder="Opsi D" required></div>
                        <div class="col-md-6"><input type="text" id="opsiE" class="form-control" placeholder="Opsi E" required></div>
                        <div class="col-md-6"><select id="kunciJawaban" class="form-select" required><option value="" disabled selected>Kunci Jawaban...</option><option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option><option value="E">E</option></select></div>
                        <div class="col-12"><button type="submit" class="btn btn-primary w-100"><i class="bi bi-send-check"></i> Kirim Soal</button></div>
                    </div>
                 </form>
            </div>
        </div>
        <hr class="my-5">
        <h3><i class="bi bi-clock-history"></i> Riwayat & Statistik Soal Anda</h3>
        <p class="text-muted">Ringkasan soal yang pernah Anda ajukan.</p>
        <div id="dosenStatSection" style="display:none;">
            <div class="row g-4 mb-4">
                <div class="col-md-4 col-sm-12"><div class="stat-card"><i class="bi bi-journal-arrow-up stat-icon"></i><div id="dosenTotalCount" class="stat-value">0</div><div class="stat-label">Total Diajukan</div></div></div>
                <div class="col-md-4 col-6"><div class="stat-card"><i class="bi bi-check-circle-fill stat-icon" style="color: var(--success-color);"></i><div id="dosenDiterimaCount" class="stat-value">0</div><div class="stat-label">Diterima</div></div></div>
                <div class="col-md-4 col-6"><div class="stat-card"><i class="bi bi-x-circle-fill stat-icon" style="color: var(--danger-color);"></i><div id="dosenDitolakCount" class="stat-value">0</div><div class="stat-label">Ditolak</div></div></div>
            </div>
        </div>
        <div id="riwayatSoalDosen"></div>
      </div>

      <!-- DASHBOARD REVIEWER -->
      <div id="reviewerView" class="content-card">
        <div class="d-flex justify-content-between align-items-center">
            <h2><i class="bi bi-person-video3"></i> Dashboard Reviewer</h2>
            <div class="d-flex align-items-center">
                <span id="userInfoReviewer"></span>
                <button class="btn btn-outline-danger btn-sm ms-3 logout-button"><i class="bi bi-box-arrow-right m-0"></i></button>
            </div>
        </div>
        <hr>
        <p class="text-muted">Ringkasan aktivitas dan daftar soal yang menunggu untuk direview sesuai peminatan Anda.</p>
        <div class="row g-4 my-4">
            <div class="col-md-3 col-6"><div class="stat-card"><i class="bi bi-hourglass-split stat-icon" style="color: var(--warning-color);"></i><div id="reviewerPendingCount" class="stat-value">...</div><div class="stat-label">Menunggu Review</div></div></div>
            <div class="col-md-3 col-6"><div class="stat-card"><i class="bi bi-journal-check stat-icon"></i><div id="reviewerTotalCount" class="stat-value">...</div><div class="stat-label">Total Direview</div></div></div>
            <div class="col-md-3 col-6"><div class="stat-card"><i class="bi bi-check-circle-fill stat-icon" style="color: var(--success-color);"></i><div id="reviewerDiterimaCount" class="stat-value">...</div><div class="stat-label">Diterima</div></div></div>
            <div class="col-md-3 col-6"><div class="stat-card"><i class="bi bi-x-circle-fill stat-icon" style="color: var(--danger-color);"></i><div id="reviewerDitolakCount" class="stat-value">...</div><div class="stat-label">Ditolak</div></div></div>
        </div>
        <hr>
        <div id="soalUntukReview" class="mt-4"></div>
      </div>

      <!-- DASHBOARD ADMIN -->
      <div id="adminView" class="content-card">
        <div class="d-flex justify-content-between align-items-center">
            <h2><i class="bi bi-person-gear"></i> Dashboard Admin</h2>
            <div class="d-flex align-items-center">
                <span id="userInfoAdmin"></span>
                <button class="btn btn-outline-danger btn-sm ms-3 logout-button"><i class="bi bi-box-arrow-right m-0"></i></button>
            </div>
        </div>
        <hr>
        <p class="text-muted">Ringkasan aktivitas sistem dan manajemen user.</p>
        <!-- Admin Stats & Tools Section -->
        <div class="card admin-sub-card mb-5">
            <div class="card-body p-4">
                <div class="row g-4">
                    <div class="col-lg-8">
                        <h3 class="mt-2"><i class="bi bi-bar-chart-line-fill"></i> Statistik Keseluruhan</h3>
                        <div class="row g-3">
                            <div class="col-sm-6"><div class="stat-card clickable h-100" onclick="showBankSoal()"><i class="bi bi-archive-fill stat-icon"></i><div id="bankSoalCount" class="stat-value">...</div><div class="stat-label">Soal di Bank Soal</div></div></div>
                            <div class="col-sm-6"><div class="stat-card h-100"><i class="bi bi-people-fill stat-icon"></i><div id="totalUserCount" class="stat-value">...</div><div class="stat-label">Total User Terdaftar</div></div></div>
                        </div>
                        <h4 class="mt-4 h5 text-center text-muted">Rekapan Aktivitas</h4>
                        <div class="row g-3">
                            <div class="col-lg-4"><div class="table-responsive"><table class="table table-sm table-hover"><thead><tr><th>Peminatan</th><th>Soal</th></tr></thead><tbody id="rekapPeminatan"></tbody></table></div></div>
                            <div class="col-lg-4"><div class="table-responsive"><table class="table table-sm table-hover"><thead><tr><th>Nama Dosen</th><th>Soal</th></tr></thead><tbody id="rekapDosen"></tbody></table></div></div>
                            <div class="col-lg-4"><div class="table-responsive"><table class="table table-sm table-hover"><thead><tr><th>Reviewer</th><th><i class="bi bi-check-lg text-success"></i></th><th><i class="bi bi-x-lg text-danger"></i></th></tr></thead><tbody id="rekapReviewer"></tbody></table></div></div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <h3 class="mt-2"><i class="bi bi-tools"></i> Alat Admin</h3>
                        <div class="list-group">
                            <button type="button" class="list-group-item list-group-item-action" onclick="openUserModal(null, 'DOSEN')"><i class="bi bi-person-plus-fill me-2"></i> Tambah Dosen Baru</button>
                            <button type="button" class="list-group-item list-group-item-action" onclick="openUserModal(null, 'REVIEWER')"><i class="bi bi-person-video3 me-2"></i> Tambah Reviewer Baru</button>
                            <button type="button" id="btnDownloadTemplateAdmin" class="list-group-item list-group-item-action"><i class="bi bi-download me-2"></i> Download Template Soal</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- User Management Section -->
        <div class="card admin-sub-card">
            <div class="card-body p-4">
                <h3 class="mb-4"><i class="bi bi-people-fill"></i> Manajemen User</h3>
                <div class="table-responsive"><table class="table table-hover"><thead><tr><th>Nama</th><th>Email</th><th>Role</th><th>Peminatan</th><th>Aksi</th></tr></thead><tbody id="userList"></tbody></table></div>
            </div>
        </div>
      </div>
    </main>
    
    <!-- BANK SOAL MODAL -->
    <div class="modal fade" id="bankSoalModal" tabindex="-1"><div class="modal-dialog modal-xl modal-dialog-scrollable"><div class="modal-content" style="border-radius: 1rem;"><div class="modal-header bg-light"><h5 class="modal-title h2" id="bankSoalModalLabel"><i class="bi bi-archive-fill me-2"></i> Bank Soal</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" id="bankSoalContent" style="background-color: var(--light-bg); padding: 1.5rem;"></div></div></div></div>

    <!-- USER MANAGEMENT MODAL (MODIFIED) -->
    <div class="modal fade" id="userModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content" style="border-radius: 1rem;"><form id="userForm"><div class="modal-header bg-light"><h5 class="modal-title h2" id="userModalLabel"></h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="hidden" id="userId" name="userId"><input type="hidden" id="userRole" name="userRole"><div class="mb-3"><label for="userNama" class="form-label">Nama Lengkap</label><input type="text" class="form-control" id="userNama" name="nama" required></div><div class="mb-3"><label for="userEmail" class="form-label">Email</label><input type="email" class="form-control" id="userEmail" name="email" required></div><div class="mb-3"><label for="userPassword" class="form-label">Password</label><input type="password" class="form-control" id="userPassword" name="password"><small class="form-text text-muted">Isi untuk menambah/mengubah. Kosongkan jika tidak ingin mengubah.</small></div><div class="mb-3"><label for="userPeminatan" class="form-label">ID Peminatan</label><input type="text" class="form-control" id="userPeminatan" name="peminatan"><small class="form-text text-muted">Pisahkan dengan koma jika lebih dari satu (e.g., P01,P02)</small></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button><button type="submit" class="btn btn-primary"><i class="bi bi-save"></i> Simpan</button></div></form></div></div></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // PASTE URL SCRIPT ANDA DI SINI
      const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzica43-Mi7CTXR0IqDdQdXM1kLZv4lbg76V5cuHiQUAlLyR1OxaKpDBWFP35j_rH-V/exec';
      
      let userModalInstance;
      
      async function callApi(action, payload, method = 'POST') {
        const spinner = document.getElementById("loginSpinner");
        if(spinner) spinner.style.display = 'block';
        try {
          const options = { method, mode: 'cors', headers: {} };
          let url = SCRIPT_URL;
          if (method === 'POST') {
              options.body = JSON.stringify({ action, payload });
          } else {
              const params = new URLSearchParams({ action, ...payload });
              url = `${SCRIPT_URL}?${params}`;
          }
          const response = await fetch(url, options);
          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
          return await response.json();
        } catch (error) {
          console.error("API call failed:", error);
          alert("Terjadi kesalahan koneksi ke server. Silakan cek konsol untuk detail.");
          throw error;
        } finally {
            if(spinner) spinner.style.display = 'none';
        }
      }
      
      function handleDownloadTemplate() {
          const headers = ["soal_text", "opsi_a", "opsi_b", "opsi_c", "opsi_d", "opsi_e", "kunci_jawaban", "id_peminatan"];
          const csvContent = "data:text/csv;charset=utf-8," + headers.join(",");
          const encodedUri = encodeURI(csvContent);
          const link = document.createElement("a");
          link.setAttribute("href", encodedUri);
          link.setAttribute("download", "template_soal.csv");
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
      }

      document.addEventListener("DOMContentLoaded", function() {
        const mainContainer = document.getElementById("mainContainer");
        const bodyEl = document.body;
        const views = {
          loginView: document.getElementById("loginView"),
          dosenView: document.getElementById("dosenView"),
          reviewerView: document.getElementById("reviewerView"),
          adminView: document.getElementById("adminView")
        };

        function showView(viewName) {
            Object.values(views).forEach(view => view.style.display = 'none');
            if(views[viewName]) {
                views[viewName].style.display = 'block';
                if(viewName === 'loginView'){
                  mainContainer.className = 'container-login';
                  bodyEl.style.alignItems = 'center';
                  bodyEl.style.justifyContent = 'center';
                } else {
                  mainContainer.className = 'container-fluid py-4';
                  bodyEl.style.alignItems = 'flex-start';
                  bodyEl.style.justifyContent = 'center';
                }
            }
        }
        
        userModalInstance = new bootstrap.Modal(document.getElementById('userModal'));

        const loggedInUser = JSON.parse(sessionStorage.getItem("loggedInUser"));
        if (loggedInUser) {
          showDashboard(loggedInUser);
        } else {
          showView("loginView");
          setupSimpleLogin();
        }

        document.getElementById("btnMasuk").addEventListener("click", handleMasuk);
        document.querySelectorAll(".logout-button").forEach(btn => btn.addEventListener("click", handleLogout));
        document.getElementById("formSoal").addEventListener("submit", handleSubmitSoal);
        document.getElementById("userForm").addEventListener("submit", handleUserFormSubmit);
        document.getElementById("btnDownloadTemplateDosen").addEventListener("click", handleDownloadTemplate);
        document.getElementById("btnDownloadTemplateAdmin").addEventListener("click", handleDownloadTemplate);
        document.getElementById("formUploadSoal").addEventListener("submit", handleSubmitUpload);

        async function handleSubmitUpload(e) {
            e.preventDefault();
            const fileInput = document.getElementById('soalFileUpload');
            const file = fileInput.files[0];
            const submitBtn = e.target.querySelector('button[type="submit"]');
            if (!file) return alert("Silakan pilih file untuk diunggah.");
            
            submitBtn.disabled = true;
            submitBtn.innerHTML = `<span class="spinner-border spinner-border-sm"></span>`;

            const reader = new FileReader();
            reader.onload = async function(event) {
                const csvData = event.target.result;
                const rows = csvData.split('\n').filter(row => row.trim() !== '');
                if (rows.length < 2) {
                    alert("File CSV kosong atau hanya berisi header.");
                    resetUploadButton(); return;
                }
                const headers = rows.shift().split(',').map(h => h.trim().replace(/"/g, ''));
                const user = JSON.parse(sessionStorage.getItem("loggedInUser"));
                const regex = /,(?=(?:(?:[^"]*"){2})*[^"]*$)/;
                const soalDataArray = rows.map(row => {
                    const values = row.split(regex).map(v => v.trim().replace(/^"|"$/g, ''));
                    const soalObj = {};
                    headers.forEach((header, i) => { soalObj[header] = values[i]; });
                    soalObj.id_dosen_pembuat = user.userId;
                    return soalObj;
                });
                try {
                    const response = await callApi('submitBulkSoal', { soalDataArray });
                    alert(response.message);
                    if (response.success) {
                        fileInput.value = '';
                        loadRiwayatSoalDosen(user.userId);
                    }
                } catch(err) {
                    alert("Gagal mengunggah file. Pastikan format file sudah benar.");
                } finally { resetUploadButton(); }
            };
            reader.onerror = () => { alert("Gagal membaca file."); resetUploadButton(); };
            reader.readAsText(file);
            function resetUploadButton() {
                submitBtn.disabled = false;
                submitBtn.innerHTML = `<i class="bi bi-upload m-0"></i>`;
            }
        }
        
        function setupSimpleLogin() {
          const emailInput = document.getElementById("emailInput");
          const passwordInput = document.getElementById("passwordInput");
          const btnMasuk = document.getElementById("btnMasuk");
          function validateForm() {
            btnMasuk.disabled = !(emailInput.value.trim() !== '' && passwordInput.value.trim() !== '');
          }
          emailInput.addEventListener("input", validateForm);
          passwordInput.addEventListener("input", validateForm);
        }

        async function handleMasuk() {
            const email = document.getElementById("emailInput").value;
            const password = document.getElementById("passwordInput").value;
            if (!email || !password) return;
            
            document.getElementById("btnMasuk").disabled = true;
            const response = await callApi('loginUser', { loginData: { email, password } });

            if(response.success){
                sessionStorage.setItem("loggedInUser", JSON.stringify(response.user));
                showDashboard(response.user);
            } else {
                alert(response.message || "Login gagal.");
                document.getElementById("btnMasuk").disabled = false;
            }
        }

        function handleLogout() {
          sessionStorage.removeItem("loggedInUser");
          location.reload();
        }
        
        function showDashboard(user) {
          const roleBadge = `<span class="badge rounded-pill role-badge">${user.role}</span>`;
          const userInfoHtml = `Halo, <strong>${user.nama}</strong> ${roleBadge}`;
          
          if (user.role === "DOSEN") {
            showView("dosenView");
            document.getElementById('userInfoDosen').innerHTML = userInfoHtml;
            document.getElementById('namaDosen').value = user.nama;
            loadPeminatanForDosen(user.peminatan);
            loadRiwayatSoalDosen(user.userId);
          } else if (user.role === "REVIEWER") {
            showView("reviewerView");
            document.getElementById('userInfoReviewer').innerHTML = userInfoHtml;
            loadReviewerDashboard(user);
          } else if (user.role === "ADMIN") {
            showView("adminView");
            document.getElementById('userInfoAdmin').innerHTML = userInfoHtml;
            loadAdminDashboard();
          }
        }

        async function loadPeminatanForDosen(userPeminatanStr) {
          const userPeminatanIds = userPeminatanStr ? userPeminatanStr.split(',') : [];
          const allPeminatanList = await callApi('getPeminatanList', {}, 'GET');
          
          const select = document.getElementById("peminatanDosen");
          select.innerHTML = '<option value="" selected disabled>Pilih peminatan...</option>';

          const filteredPeminatan = allPeminatanList.filter(p => userPeminatanIds.includes(p.id.toString()));

          if (filteredPeminatan.length === 0) {
              select.innerHTML = '<option value="" disabled selected>Anda tidak terdaftar pada peminatan manapun.</option>';
              select.disabled = true;
              document.querySelector('#formSoal button[type="submit"]').disabled = true;
          } else {
              filteredPeminatan.forEach(p => {
                  select.innerHTML += `<option value="${p.id}">${p.nama}</option>`;
              });
              select.disabled = false;
              document.querySelector('#formSoal button[type="submit"]').disabled = false;
          }
        }
        
        async function handleSubmitSoal(e) {
          e.preventDefault();
          const user = JSON.parse(sessionStorage.getItem("loggedInUser"));
          const soalData = {
              soal_text: document.getElementById("soalText").value, opsi_a: document.getElementById("opsiA").value,
              opsi_b: document.getElementById("opsiB").value, opsi_c: document.getElementById("opsiC").value,
              opsi_d: document.getElementById("opsiD").value, opsi_e: document.getElementById("opsiE").value,
              kunci_jawaban: document.getElementById("kunciJawaban").value, id_peminatan: document.getElementById("peminatanDosen").value,
              id_dosen_pembuat: user.userId
          };
          if (!soalData.id_peminatan || !soalData.kunci_jawaban) return alert("Peminatan dan Kunci Jawaban wajib dipilih.");

          const submitBtn = e.target.querySelector('button[type="submit"]');
          submitBtn.disabled = true;
          submitBtn.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Mengirim...`;
          
          const response = await callApi('submitSoal', { soalData });
          alert(response.message);
          if (response.success) {
            document.getElementById("formSoal").reset();
            document.getElementById('namaDosen').value = user.nama;
            loadRiwayatSoalDosen(user.userId);
          }
          submitBtn.disabled = false;
          submitBtn.innerHTML = `<i class="bi bi-send-check"></i> Kirim Soal`;
        }
        
        async function loadRiwayatSoalDosen(dosenId) {
            const container = document.getElementById("riwayatSoalDosen");
            container.innerHTML = '<div class="text-center"><div class="spinner-border text-secondary" role="status"></div></div>';
            document.getElementById("dosenStatSection").style.display = 'block';
            
            const soalList = await callApi('getSoalByDosen', { dosenId }, 'GET');
            document.getElementById("dosenTotalCount").textContent = soalList.length;
            document.getElementById("dosenDiterimaCount").textContent = soalList.filter(s => s.status === 'DITERIMA').length;
            document.getElementById("dosenDitolakCount").textContent = soalList.filter(s => s.status === 'DITOLAK').length;

            if (!soalList || soalList.length === 0) {
              container.innerHTML = '<div class="alert alert-light text-center border">Anda belum pernah mengajukan soal.</div>';
              return;
            }
            let html = '<div class="table-responsive"><table class="table table-striped table-hover"><thead><tr><th>Soal</th><th>Status</th><th>Catatan Reviewer</th></tr></thead><tbody>';
            soalList.slice().reverse().forEach(soal => {
              let statusBadge = '';
              switch(soal.status) {
                case 'DITERIMA': statusBadge = '<span class="badge bg-success">DITERIMA</span>'; break;
                case 'DITOLAK': statusBadge = '<span class="badge bg-danger">DITOLAK</span>'; break;
                case 'MENUNGGU_REVIEW': statusBadge = '<span class="badge bg-warning text-dark">MENUNGGU REVIEW</span>'; break;
                default: statusBadge = `<span class="badge bg-secondary">${soal.status}</span>`;
              }
              html += `<tr><td>${soal.soal_text.substring(0, 70)}...</td><td>${statusBadge}</td><td>${soal.catatan_reviewer || '-'}</td></tr>`;
            });
            container.innerHTML = html + '</tbody></table></div>';
        }

        async function loadReviewerDashboard(user) {
            const peminatanIds = user.peminatan || '';
            const stats = await callApi('getReviewerStats', { reviewerId: user.userId }, 'GET');
            if (stats) {
                document.getElementById("reviewerPendingCount").textContent = stats.pendingReview;
                document.getElementById("reviewerTotalCount").textContent = stats.totalReviewed;
                document.getElementById("reviewerDiterimaCount").textContent = stats.totalAccepted;
                document.getElementById("reviewerDitolakCount").textContent = stats.totalRejected;
            }
            loadSoalForReviewer(peminatanIds);
        }

        async function loadSoalForReviewer(peminatanIdsStr) {
          const soalList = await callApi('getSoalForReviewer', { peminatanIds: peminatanIdsStr }, 'GET');
          const container = document.getElementById("soalUntukReview");
          if (!soalList || soalList.length === 0) {
            container.innerHTML = '<div class="alert alert-info text-center"><i class="bi bi-emoji-sunglasses"></i> Tidak ada soal yang perlu direview pada peminatan Anda saat ini.</div>';
            return;
          }
          container.innerHTML = soalList.map(soal => `
            <div class="card reviewer-card mb-4" id="card_${soal.id_soal}">
              <div class="card-header d-flex justify-content-between">
                <span>Soal dari: <strong>${soal.nama_dosen_pembuat}</strong></span>
                <span class="badge bg-primary align-self-center">${soal.nama_peminatan}</span>
              </div>
              <div class="card-body">
                <p class="card-text bg-light p-3 rounded" style="white-space: pre-wrap;">${soal.soal_text}</p>
                <ul class="list-group list-group-flush mb-3">
                  ${['a','b','c','d','e'].map(opt => `<li class="list-group-item ${soal.kunci_jawaban.toUpperCase() === opt.toUpperCase() ? 'correct-answer' : ''}"><strong>${opt.toUpperCase()}:</strong> ${soal['opsi_'+opt]}</li>`).join('')}
                </ul>
                <p><strong>Kunci Jawaban: ${soal.kunci_jawaban.toUpperCase()}</strong></p><hr>
                <div class="mb-3"><textarea class="form-control" id="catatan_${soal.id_soal}" rows="2" placeholder="Catatan Review (Wajib jika ditolak)"></textarea></div>
                <div class="d-flex justify-content-end gap-2">
                  <button class="btn btn-danger" onclick="handleReview('${soal.id_soal}', 'DITOLAK', this)"><i class="bi bi-x-circle"></i> Tolak</button>
                  <button class="btn btn-success" onclick="handleReview('${soal.id_soal}', 'DITERIMA', this)"><i class="bi bi-check-circle"></i> Terima</button>
                </div>
              </div>
            </div>`).join('');
        }

        window.handleReview = async function(id_soal, status, buttonElement) {
            const user = JSON.parse(sessionStorage.getItem("loggedInUser"));
            const catatan = document.getElementById(`catatan_${id_soal}`).value;
            if (status === 'DITOLAK' && !catatan.trim()) return alert("Catatan wajib diisi jika menolak soal.");
            const buttonContainer = buttonElement.parentElement;
            buttonContainer.querySelectorAll('.btn').forEach(btn => btn.disabled = true);
            buttonElement.innerHTML = `<span class="spinner-border spinner-border-sm"></span>`;
            const reviewData = { id_soal, status, catatan, id_reviewer: user.userId };
            const response = await callApi('processReview', { reviewData });
            alert(response.message);
            if (response.success) {
              const cardToRemove = document.getElementById(`card_${id_soal}`);
              cardToRemove.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
              cardToRemove.style.opacity = '0'; cardToRemove.style.transform = 'scale(0.95)';
              setTimeout(() => {
                cardToRemove.remove();
                if (document.getElementById("soalUntukReview").children.length === 0) {
                  loadSoalForReviewer(user.peminatan);
                }
                loadReviewerDashboard(user);
              }, 500);
            } else {
               buttonContainer.querySelectorAll('.btn').forEach(btn => btn.disabled = false);
               buttonContainer.querySelector('.btn-success').innerHTML = '<i class="bi bi-check-circle"></i> Terima';
               buttonContainer.querySelector('.btn-danger').innerHTML = '<i class="bi bi-x-circle"></i> Tolak';
            }
        }
        
        // --- ADMIN DASHBOARD (OPTIMIZED) ---
        async function loadAdminDashboard() {
            // Call the new combined endpoint
            const data = await callApi('getAdminDashboardData', {}, 'GET');
            if (data) {
                populateAdminStats(data.stats);
                populateUserTables(data.users);
            }
        }

        function populateAdminStats(stats) {
          if (!stats) return;
          document.getElementById('bankSoalCount').textContent = stats.bankSoalCount || 0;
          
          const rekapDosenBody = document.getElementById('rekapDosen');
          rekapDosenBody.innerHTML = Object.keys(stats.soalPerDosen).length > 0 ?
            Object.entries(stats.soalPerDosen).map(([dosen, count]) => `<tr><td>${dosen.split(" ")[0]}</td><td>${count}</td></tr>`).join('') :
            '<tr><td colspan="2" class="text-center text-muted">-</td></tr>';
          
          const rekapReviewerBody = document.getElementById('rekapReviewer');
          rekapReviewerBody.innerHTML = Object.keys(stats.reviewPerReviewer).length > 0 ?
            Object.values(stats.reviewPerReviewer).map(data => `<tr><td>${data.nama.split(" ")[0]}</td><td>${data.diterima}</td><td>${data.ditolak}</td></tr>`).join('') :
            '<tr><td colspan="3" class="text-center text-muted">-</td></tr>';

          const rekapPeminatanBody = document.getElementById('rekapPeminatan');
          rekapPeminatanBody.innerHTML = stats.soalPerPeminatan && Object.keys(stats.soalPerPeminatan).length > 0 ?
            Object.entries(stats.soalPerPeminatan).map(([peminatan, count]) => `<tr><td>${peminatan}</td><td>${count}</td></tr>`).join('') :
            '<tr><td colspan="2" class="text-center text-muted">-</td></tr>';
        }

        function populateUserTables(users) {
            if (!users) return;
            document.getElementById('totalUserCount').textContent = users.length || 0;
            const userListBody = document.getElementById('userList');
            userListBody.innerHTML = '';
          
            users.forEach(user => {
                const row = `<tr>
                  <td>${user.nama}</td>
                  <td>${user.email || '-'}</td>
                  <td><span class="badge bg-info text-dark">${user.role}</span></td>
                  <td><span class="badge bg-secondary">${(user.peminatan || '-').replace(/,/g, ', ')}</span></td>
                  <td>
                    <button class="btn btn-sm btn-outline-primary py-1 px-2" onclick='openUserModal(${JSON.stringify(user)}, "${user.role}")'><i class="bi bi-pencil-square"></i></button>
                    <button class="btn btn-sm btn-outline-danger py-1 px-2" onclick="handleDeleteUser('${user.userId}', '${user.nama}')"><i class="bi bi-trash"></i></button>
                  </td></tr>`;
                userListBody.innerHTML += row;
            });
        }
        
        window.openUserModal = function(user, role) {
          const form = document.getElementById('userForm');
          form.reset();
          document.getElementById('userRole').value = role;
          const label = document.getElementById('userModalLabel');
          label.innerHTML = `<i class="bi ${role === 'DOSEN' ? 'bi-person-plus-fill' : 'bi-person-video3'} me-2"></i>`;
          if (user) { // Edit mode
            label.innerHTML += `Edit Data ${role.charAt(0).toUpperCase() + role.slice(1).toLowerCase()}`;
            document.getElementById('userId').value = user.userId;
            document.getElementById('userNama').value = user.nama;
            document.getElementById('userEmail').value = user.email || '';
            document.getElementById('userPeminatan').value = user.peminatan || '';
            document.getElementById('userPassword').placeholder = "Kosongkan jika tidak diubah";
            document.getElementById('userPassword').required = false;
          } else { // Add mode
            label.innerHTML += `Tambah ${role.charAt(0).toUpperCase() + role.slice(1).toLowerCase()} Baru`;
            document.getElementById('userId').value = '';
            document.getElementById('userPassword').placeholder = "Password wajib diisi";
            document.getElementById('userPassword').required = true;
          }
          userModalInstance.show();
        }

        async function handleUserFormSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.disabled = true;

            const userData = {
                userId: form.userId.value,
                nama: form.userNama.value,
                email: form.userEmail.value,
                role: form.userRole.value,
                password: form.userPassword.value,
                peminatan: form.userPeminatan.value,
            };
            
            const action = userData.userId ? 'updateUser' : 'addUser';
            if(action === 'addUser' && !userData.password){
                alert("Password wajib diisi untuk user baru.");
                submitBtn.disabled = false; return;
            }

            try {
                const response = await callApi(action, { userData });
                alert(response.message);
                if(response.success) {
                    userModalInstance.hide();
                    loadAdminDashboard(); // Reload data
                }
            } catch(error) {
                // Error already alerted by callApi, we can just log it
                console.error(error);
            } finally {
                submitBtn.disabled = false;
            }
        }
        
        window.handleDeleteUser = async function(userId, userName) {
            if (confirm(`Yakin ingin menghapus user "${userName}"?`)) {
                const response = await callApi('deleteUser', { userId });
                alert(response.message);
                if (response.success) loadAdminDashboard();
            }
        }

        let bankSoalModalInstance;
        window.showBankSoal = async function() {
            if (!bankSoalModalInstance) bankSoalModalInstance = new bootstrap.Modal(document.getElementById('bankSoalModal'));
            const modalBody = document.getElementById('bankSoalContent');
            modalBody.innerHTML = '<div class="text-center p-5"><div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status"></div></div>';
            bankSoalModalInstance.show();
            const bankSoalList = await callApi('getBankSoal', {}, 'GET');
            if (!bankSoalList || bankSoalList.length === 0) {
                modalBody.innerHTML = '<div class="alert alert-info text-center m-3">Bank Soal masih kosong.</div>';
                return;
            }
            modalBody.innerHTML = bankSoalList.map((soal, index) => `
                <div class="card reviewer-card mb-3">
                  <div class="card-header d-flex justify-content-between">
                    <span>Soal #${index + 1} (Dari: ${soal.nama_dosen_pembuat})</span>
                    <span class="badge bg-primary">Peminatan ID: ${soal.id_peminatan}</span>
                  </div>
                  <div class="card-body">
                    <p class="card-text bg-light p-3 rounded" style="white-space: pre-wrap;">${soal.soal_text}</p>
                    <ul class="list-group list-group-flush">${['a','b','c','d','e'].map(opt => `<li class="list-group-item ${soal.kunci_jawaban.toUpperCase() === opt.toUpperCase() ? 'correct-answer' : ''}"><strong>${opt.toUpperCase()}:</strong> ${soal['opsi_'+opt]}</li>`).join('')}</ul>
                  </div>
                </div>`).join('');
        }
      });
    </script>

  </body>
</html>
